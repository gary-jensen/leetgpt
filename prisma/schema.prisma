// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client-js"
}

enum Role {
    BASIC
    PRO
    ADMIN
}

model User {
    id                     String                  @id @default(uuid())
    email                  String                  @unique
    name                   String?
    image                  String?
    emailVerified          DateTime?
    emailNotifications     Boolean                 @default(false)
    createdAt              DateTime                @default(now())
    updatedAt              DateTime                @updatedAt
    role                   Role                    @default(PRO)
    progress               UserProgress?
    sessions               UserSession[]
    analyticsEvents        AnalyticsEvent[]
    accounts               Account[]
    sessions_auth          Session[]
    algoProblemProgress    AlgoProblemProgress[]
    algoLessonProgress     AlgoLessonProgress[]
    algoProblemSubmissions AlgoProblemSubmission[]
}

model UserProgress {
    id             String   @id @default(uuid())
    userId         String   @unique
    user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    xp             Int      @default(0)
    level          Int      @default(1)
    lessonProgress Json     @default("{}")
    updatedAt      DateTime @updatedAt
}

model UserSession {
    id               String    @id @default(uuid())
    userId           String
    user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    sessionStart     DateTime  @default(now())
    sessionEnd       DateTime?
    durationSeconds  Int?
    lessonsCompleted Int       @default(0)
}

model AnalyticsEvent {
    id            String   @id @default(uuid())
    userId        String?
    user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
    guestId       String?
    eventCategory String
    eventAction   String
    eventLabel    String?
    eventValue    Int?
    metadata      Json?
    sessionId     String?
    isDev         Boolean  @default(false)
    // All device/browser/location data in one JSON field
    deviceData    Json? // Contains: userAgent, browser, os, deviceType, ipAddress, country, screenSize, etc.
    createdAt     DateTime @default(now())

    @@index([userId, createdAt])
    @@index([guestId, createdAt])
    @@index([eventCategory, eventAction])
    @@index([sessionId])
    @@index([isDev])
}

model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?
    user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

// Algorithm progress models
model AlgoProblemProgress {
    id          String    @id @default(cuid())
    userId      String
    problemId   String // References hardcoded problem ID (e.g., "sum-to-target")
    language    String // "javascript" for MVP
    status      String // "not_started" | "in_progress" | "completed"
    currentCode String    @db.Text // Latest code (properly escaped)
    chatHistory Json // Array of chat messages with AI
    completedAt DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, problemId, language])
}

model AlgoLessonProgress {
    id          String    @id @default(cuid())
    userId      String
    lessonId    String // References hardcoded lesson ID (e.g., "hashmap-basics")
    status      String // "not_started" | "in_progress" | "completed"
    completedAt DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, lessonId])
}

// Algorithm content models
model AlgoProblem {
    id             String   @id @default(cuid())
    slug           String   @unique
    title          String
    order          Int
    statementMd    String   @db.Text
    statementHtml  String?  @db.Text
    topics         String[]
    difficulty     String
    languages      String[]
    rubric         Json
    parameterNames String[]
    tests          Json
    startingCode   Json
    passingCode    Json
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    @@index([difficulty])
    @@index([slug])
    @@index([order])
}

model AlgoLesson {
    id             String   @id @default(cuid())
    slug           String   @unique
    title          String
    summary        String
    topics         String[]
    difficulty     String
    readingMinutes Int
    bodyMd         String   @db.Text
    bodyHtml       String?  @db.Text
    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    @@index([difficulty])
    @@index([slug])
}

model AlgoProblemSubmission {
    id          String   @id @default(cuid())
    userId      String
    problemId   String
    language    String
    code        String   @db.Text
    passed      Boolean
    runtime     Int?
    testsPassed Int
    testsTotal  Int
    submittedAt DateTime @default(now())
    user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId, problemId])
    @@index([submittedAt])
}
